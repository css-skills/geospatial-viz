---
title: "Geospatial visualizations with R"
author: "Computation Skills Workshop"
output: rcfss::xaringan
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  cache = TRUE,
  message = FALSE,
  warning = FALSE,
  echo = FALSE,
  fig.retina = 2, fig.width = 12
)

library(tidyverse)
library(sf)
library(ggmap)
library(tidycensus)
library(RColorBrewer)
library(patchwork)
library(rnaturalearth)
library(here)
library(countdown)

# easier to generate tidycensus maps
if (!identical(getOption("bitmapType"), "cairo") && isTRUE(capabilities()[["cairo"]])) {
  options(bitmapType = "cairo")
}

set.seed(123)
theme_set(theme_minimal(base_size = rcfss::base_size))
```

# Geospatial visualizations

* Earliest form of information visualizations
* Geospatial data visualizations
* [Google Maps](https://www.google.com/maps)

---

# Dr. John Snow

.center[

[![:scale 70%](https://upload.wikimedia.org/wikipedia/commons/2/27/Snow-cholera-map-1.jpg)](https://commons.wikimedia.org/wiki/File:Snow-cholera-map-1.jpg)

]

.footnote[https://en.wikipedia.org/wiki/John_Snow]

---

# Designing modern maps

* Depict spatial features
* Incorporate additional attributes and information
* Major features
    * Scale
    * Projection
    * Symbols

---

# Scale

* Proportion between distances and sizes on a map and their actual distances and sizes on Earth
* Small-scale map
* Large-scale map


---

# Large-scale map

```{r large-scale}
# establish bounding box, get map, and plot
c(
  left = -128.364258,
  bottom = 11.480025,
  right = -65.742188,
  top = 55.329144
) %>%
  get_stamenmap(zoom = 5) %>%
  ggmap()
```

---

# Small-scale map

```{r small-scale}
# establish bounding box, get map, and plot
c(
  left = -87.612448,
  bottom = 41.783393,
  right = -87.581871,
  top = 41.803470
) %>%
  get_stamenmap(zoom = 15) %>%
  ggmap()
```

---

# Projection

* Process of taking a three-dimensional object and visualizing it on a two-dimensional surface
* No 100% perfect method for this
* Always introduces distortions
* Properties of projection methods
    1. Shape
    1. Area
    1. Angles
    1. Distance
    1. Direction

---

# Conformal projections

```{r import-world, include = FALSE}
world <- ne_countries(returnclass = "sf")
```

```{r mercator, dependson = "import-world"}
world %>%
  st_transform("+proj=merc") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mercator projection")
```

---

# Equal-area projections

```{r equal-area, dependson = "import-world"}
{
  world %>%
    st_transform("+proj=laea") %>%
    ggplot() +
    geom_sf() +
    ggtitle("Lambert equal area") +
    theme_minimal(base_size = rcfss::base_size * .7)
} +
  {
    world %>%
      st_transform("+proj=cea") %>%
      ggplot() +
      geom_sf() +
      ggtitle("Equal area cylindrical") +
      theme_minimal(base_size = rcfss::base_size * .7)
  } +
  plot_layout(ncol = 1, height = c(5, 5))
```

---

# Mollweide

```{r mollweide, dependson = "import-world"}
world %>%
  st_transform("+proj=moll") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mollweide projection")
```

---

# Symbols

```{r bb-hydepark-stamen}
# store bounding box coordinates
hydepark_bb <- c(
  left = -87.612448,
  bottom = 41.783393,
  right = -87.581871,
  top = 41.803470
)

hydepark_stamen <- get_stamenmap(
  bbox = hydepark_bb,
  zoom = 16
)
ggmap(hydepark_stamen)
```

---

# `ggmap`

* Package for drawing maps using `ggplot2` and **raster** map tiles
* Static image files generated by mapping services
* Focus on incorporating data into existing maps
* Severely limits ability to change the appearance of the geographic map
- Specifying map region

---

# Bounding box

.pull-left[

```{r bb-chicago-stamen, eval = FALSE, echo = TRUE}
# store bounding box coordinates
chi_bb <- c(
  left = -87.936287,
  bottom = 41.679835,
  right = -87.447052,
  top = 42.000835
)

chicago <- get_stamenmap(
  bbox = chi_bb,
  zoom = 11
)

ggmap(chicago)
```

]

.pull-right[

```{r bb-chicago-stamen-out, ref.label = "bb-chicago-stamen", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Level of detail

```{r bb-chicago-stamen-zoom}
{
  get_stamenmap(
    bbox = chi_bb,
    zoom = 12
  ) %>%
    ggmap() +
    ggtitle("Zoom = 12")
} + {
  get_stamenmap(
    bbox = chi_bb,
    zoom = 10
  ) %>%
    ggmap() +
    ggtitle("Zoom = 10")
}
```

---

# Identifying bounding box

> Use [bboxfinder.com](http://bboxfinder.com/#0.000000,0.000000,0.000000,0.000000) to determine the exact longitude/latitude coordinates for the bounding box you wish to obtain.

---

# Types of map tiles

```{r stamen-maptype, echo = FALSE}
stamen_maptype <- tibble(maptype = c(
  "terrain", "terrain-background",
  "terrain-lines",
  "toner", "toner-2010", "toner-2011",
  "toner-background", "toner-hybrid",
  "toner-labels", "toner-lines",
  "toner-lite", "watercolor"
)) %>%
  mutate(
    bb = map(maptype, ~ get_stamenmap(bbox = chi_bb, zoom = 10, maptype = .x)),
    ggmap = map2(bb, maptype, ~ ggmap(.x) +
      ggtitle(.y) +
      theme_minimal(base_size = rcfss::base_size * 0.4))
  )

wrap_plots(stamen_maptype$ggmap)
```

---

# Import crime data

* City of Chicago open data portal
* [Crime data from 2017](https://data.cityofchicago.org/Public-Safety/Crimes-2017/d62x-nvdr)

```{r import-crimes}
crimes <- here("data", "chicago-crimes.csv") %>%
  read_csv()
glimpse(crimes)
```

---

# Plot high-level map of crime

.pull-left[

```{r import-chicago, eval = FALSE, echo = TRUE}
ggmap(chicago)
```

]

.pull-right[

```{r import-chicago-out, ref.label = "import-chicago", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Using `geom_point()`

.pull-left[

```{r plot-crime-point, dependson = "import-crimes", eval = FALSE, echo = TRUE}
ggmap(chicago) +
  geom_point(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    )
  )
```

]

.pull-right[

```{r plot-crime-point-out, ref.label = "plot-crime-point", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Using `geom_point()`

.pull-left[

```{r plot-crime-point-alpha, dependson = "import-crimes", eval = FALSE, echo = TRUE}
ggmap(chicago) +
  geom_point(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    ),
    size = .25,
    alpha = .01
  )
```


]

.pull-right[

```{r plot-crime-point-alpha-out, ref.label = "plot-crime-point-alpha", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Using `stat_density_2d()`

.pull-left[

```{r kde-contour, dependson = "import-crimes", eval = FALSE, echo = TRUE}
ggmap(chicago) +
  geom_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    )
  )
```

]

.pull-right[

```{r kde-contour-out, ref.label = "kde-contour", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Using `stat_density_2d()`

.pull-left[

```{r kde-fill, dependson = "import-crimes", eval = FALSE, echo = TRUE}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    geom = "polygon"
  )
```

]

.pull-right[

```{r kde-fill-out, ref.label = "kde-fill", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Using `stat_density_2d()`

.pull-left[

```{r plot-crime-density, dependson = "import-crimes", eval = FALSE, echo = TRUE}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .2,
    bins = 25,
    geom = "polygon"
  )
```

]

.pull-right[

```{r plot-crime-density-out, ref.label = "plot-crime-density", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Looking for variation

.pull-left[

```{r plot-crime-wday, dependson = "import-crimes", eval = FALSE, echo = TRUE}
ggmap(chicago) +
  stat_density_2d(
    data = crimes %>%
      filter(`Primary Type` %in% c(
        "BURGLARY", "MOTOR VEHICLE THEFT",
        "NARCOTICS", "ROBBERY"
      )),
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .4,
    bins = 10,
    geom = "polygon"
  ) +
  facet_wrap(facets = vars(`Primary Type`))
```

]

.pull-right[

```{r plot-crime-wday-out, ref.label = "plot-crime-wday", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Exercise using `ggmap`

- City of Chicago data portal
- 311 service requests

```{r cache = FALSE}
countdown(minutes = 15)
```

---

# Map data file formats

* Vector files
    * Raster images
    * Numeric data
* Popular formats
    * Shapefile
    * GeoJSON
    
---

# Shapefile

* Encodes points, lines, and polygons
* Collection of files
    * `.shp` - geographic coordinates
    * `.dbf` - data associated with the geographic features
    * `.prj` - projection of the coordinates in the shapefile

---

# GeoJSON

* Uses **J**ava**S**cript **O**bject **N**otation (JSON) file format
    
    ```json
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [125.6, 10.1]
      },
      "properties": {
        "name": "Dinagat Islands"
      }
    }
    ```
* Plain text files

---

# Simple features

* [Packages in R for spatial data](https://cran.r-project.org/web/views/Spatial.html)
* Tidy packages for spatial data
* Simple features and `sf`
    * Emphasizes spatial geometry
    * Describes how to store and retrieve objects
    * Defines geometrical operations

---

# What is a feature?

* Thing or an object in the real world
* Sets of features
* Geometry
* Attributes

---

# Dimensions

* Geometries composed of points
    * Coordinates in a 2-, 3- or 4-dimensional space
    * All points in a geometry have the same dimensionality
* X and Y coordinates
* Z coordinate
* M coordinate (measure associated with point rather than the feature)

---

# Simple feature geometry types

| type | description                                             |
| ---- | ------------------------------------------------------- |
| `POINT` | zero-dimensional geometry containing a single point |
| `LINESTRING` | sequence of points connected by straight, non-self intersecting line pieces; one-dimensional geometry |
| `POLYGON` | geometry with a positive area (two-dimensional); sequence of points form a closed, non-self intersecting ring; the first ring denotes the exterior ring, zero or more subsequent rings denote holes in this exterior ring |

--

* `MULTIPOINT`
* `MULTILINESTRING`
* `MULTIPOLYGON`

---

# Simple features in R

* Uses basic R data structures
* Data frame with one row per feature
* Lots of list columns

---

# Importing shapefiles

```{r import-usa-shape, echo = TRUE}
usa_shape <- here("data", "cb_2020_us_state_5m", "cb_2020_us_state_5m.shp") %>%
  st_read()
```

---

# Importing shapefiles

```{r import-usa-shape-print, echo = TRUE}
usa_shape
```

---

# Importing GeoJSON files

```{r import-chi-json, echo = TRUE}
chi_json <- here("data", "community-area-boundaries.geojson") %>%
  st_read()
```

---

# Importing GeoJSON files

```{r import-chi-json-print, echo = TRUE}
chi_json
```

---

# Drawing maps with `sf` objects

```{r import-usa, echo = TRUE}
usa <- here("data", "cb_2020_us_state_5m", "cb_2020_us_state_5m.shp") %>%
  st_read()
```

---

# USA boundaries

```{r geom-sf, echo = TRUE}
ggplot(data = usa) +
  geom_sf()
```

---

# Plot a subset of a map

```{r usa-subset, echo = TRUE, fig.height = 5}
usa_48 <- usa %>%
  filter(NAME %in% state.name) %>%
  filter(NAME != "Alaska", NAME != "Hawaii")

ggplot(data = usa_48) +
  geom_sf()
```

---

# Just another `ggplot()`

```{r usa-fill, echo = TRUE}
ggplot(data = usa_48) +
  geom_sf(fill = "palegreen", color = "black")
```

---

# `urbnmapr`

```{r urbnmapr, echo = TRUE, fig.height = 5}
# devtools::install_github("UrbanInstitute/urbnmapr")
library(urbnmapr)

states_sf <- get_urbn_map("states", sf = TRUE)

ggplot(data = states_sf) +
  geom_sf()
```

---

# Points

```{r chi-crimes, echo = TRUE}
crimes_homicide <- filter(.data = crimes, `Primary Type` == "HOMICIDE")
crimes_homicide
```

---

# Points

```{r scatter, echo = TRUE}
ggplot(data = crimes_homicide, mapping = aes(x = Longitude, y = Latitude)) +
  geom_point()
```

---

# Points

.pull-left[

```{r chi-crime, eval = FALSE, echo = TRUE}
ggplot(data = chi_json) +
  geom_sf() +
  geom_point(
    data = crimes_homicide,
    mapping = aes(x = Longitude, y = Latitude),
    shape = 1
  )
```

]

.pull-right[

```{r chi-crime-out, ref.label = "chi-crime", eval = TRUE, echo = FALSE, fig.width = 6}
```

]

---

# Converting to `sf` data frame

```{r crimes-sf, echo = TRUE}
crimes_homicide_sf <- st_as_sf(x = crimes_homicide, coords = c("Longitude", "Latitude"))
st_crs(crimes_homicide_sf) <- 4326 # set the coordinate reference system
crimes_homicide_sf
```

---

# Plotting with two sf data frames

```{r crimes-sf-plot, echo = TRUE, fig.height = 7}
ggplot() +
  geom_sf(data = chi_json) +
  geom_sf(data = crimes_homicide_sf, shape = 1)
```

---

# Fill (choropleths)

```{r import-foreign, echo = TRUE}
fb_state <- read_csv(file = here("data", "foreign-born.csv"))
fb_state
```

---

# Join the data

```{r usa-foreign-join, echo = TRUE}
usa_fb <- left_join(x = usa_48, y = fb_state, by = c("STATEFP" = "GEOID", "NAME"))
usa_fb
```

---

# Draw the map

```{r geom-map-state, echo = TRUE}
ggplot(data = usa_fb) +
  geom_sf(mapping = aes(fill = pct_foreign))
```

---

# Exercise using household income

```{r cache = FALSE}
countdown(minutes = 10)
```

---

# Bin data to discrete intervals

* Continuous vs. discrete variables for color
* Collapse to a discrete variable

---

# `cut_interval()`

```{r cut-interval, echo = TRUE}
usa_fb %>%
  mutate(rate_cut = cut_interval(pct_foreign, n = 6)) %>%
  ggplot() +
  geom_sf(aes(fill = rate_cut))
```

---

# `cut_number()`

```{r cut-number, echo = TRUE}
usa_fb %>%
  mutate(rate_cut = cut_number(pct_foreign, n = 6)) %>%
  ggplot() +
  geom_sf(aes(fill = rate_cut))
```

---

# Map projection

<iframe width="560" height="315" src="https://www.youtube.com/embed/vVX-PrBRtTY?rel=0" frameborder="0" allowfullscreen></iframe>

---

# Map projection

.center[

![[Mercator Projection](https://xkcd.com/2082/)](https://imgs.xkcd.com/comics/mercator_projection.png)

]

---

# Map projection

* Coordinate reference system
* `proj4string`

---

# Mercator projection

```{r projections}
map_proj_base <- ggplot(data = usa_48) +
  geom_sf()
```

```{r mercator-sf, echo = TRUE, fig.height = 6}
map_proj_base +
  coord_sf(crs = "+proj=merc") +
  ggtitle("Mercator projection")
```

---

# Projection using standard lines

```{r projection-rest}
{
  map_proj_base +
    coord_sf(crs = "+proj=cea +lon_0=0 +lat_ts=45") +
    labs(
      title = "Gall-Peters",
      subtitle = '"+proj=cea +lon_0=0 +lat_ts=45"'
    )
} +
  {
    map_proj_base +
      coord_sf(crs = "+proj=laea +lat_0=35 +lon_0=-100") +
      labs(
        title = "Lambert azimuthal",
        subtitle = '"+proj=laea +lat_0=35 +lon_0=-100"'
      )
  } +
  {
    map_proj_base +
      coord_sf(crs = "+proj=aea +lat_1=25 +lat_2=50 +lon_0=-100") +
      labs(
        title = "Albers equal-area",
        subtitle = '"+proj=aea +lat_1=25 +lat_2=50 +lon_0=-100"'
      )
  } +
  {
    map_proj_base +
      coord_sf(crs = "+proj=aea +lat_1=0 +lat_2=80 +lon_0=-100") +
      labs(
        title = "Albers equal-area",
        subtitle = '"+proj=aea +lat_1=0 +lat_2=80 +lon_0=-100"'
      )
  } +
  plot_layout(ncol = 2, nrow = 2) &
  theme_minimal(base_size = rcfss::base_size * .75)
```
